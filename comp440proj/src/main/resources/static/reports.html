<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>All Users</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div id="search">
    <section id="field-section">
        <h3>1) Most expensive items in each category</h3>
        <button class="button-sm" id="btnExpensive">Run</button>
        <div id="outExpensive" style="margin-top:8px;"></div>
    </section>

    <section id="field-section">
        <h3>2) Users who posted category X and Y on the same day</h3>
        <div id="input-section">
            <input id="catX" placeholder="Category X" />
            <input id="catY" placeholder="Category Y" />
            <button class="button-sm" id="btnSameDay">Search</button>
        </div>
        <div id="outSameDay" style="margin-top:8px;"></div>
    </section>

    <section id="field-section">
        <h3>3) "Excellent/Good" rated items by User</h3>
        <div id="input-section">
            <input id="ratingsUsername" placeholder="Username" />
            <button class="button-sm" id="btnRatings">Search</button>
        </div>
        <div id="outRatings" style="margin-top:8px;"></div>
    </section>

    <section id="field-section">
        <h3>4) Users who posted on a certain date</h3>
        <div id="input-section">
            <input type="date" id="specificDateInput"/>
            <button class="button-sm" id="btnSpecificDate">Search</button>
        </div>
        <div id="outSpecificDate" style="margin-top:8px;"></div>
    </section>
    <button class="button-sm" id="home-btn">Home</button>
    <button class="button-sm" id="logout">Logout</button>
</div>

<script>
    function renderTable(containerId, rows) {
        const el = document.getElementById(containerId);
        if (!rows || rows.length === 0) { el.innerHTML = "<i>No results</i>"; return; }
        const headers = Object.keys(rows[0]);
        const thead = `<tr>${headers.map(h=>`<th>${h}</th>`).join("")}</tr>`;
        const tbody = rows.map(r => `<tr>${headers.map(h=>`<td>${r[h] ?? ""}</td>`).join("")}</tr>`).join("");
        el.innerHTML = `<table style="width:100%; border-collapse:collapse">
    <thead>${thead}</thead><tbody>${tbody}</tbody></table>`;
    }

    // #1
    document.getElementById("btnExpensive").onclick = async () => {
        const res = await fetch("/reports/expensive-by-category");
        renderTable("outExpensive", await res.json());
    };

    // #2
    document.getElementById("btnSameDay").onclick = async () => {
        const catX = document.getElementById("catX").value.trim();
        const catY = document.getElementById("catY").value.trim();
        if (!catX || !catY) return alert("Enter both categories.");
        const res = await fetch(`/reports/users-same-day-two-cats?catX=${encodeURIComponent(catX)}&catY=${encodeURIComponent(catY)}`);
        const data = (await res.json()).map(u => ({ username: u }));
        renderTable("outSameDay", data);
    };

    // #3
    document.getElementById("btnRatings").onclick = async () => {
        console.log("Search clicked!");
        const username = document.getElementById("ratingsUsername").value.trim();
        if (!username) return alert("Please enter a username.");

        const res = await fetch(`/items/ratings-by-user?username=${encodeURIComponent(username)}`);
        const data = await res.json();

        renderTable("outRatings", data);
    };


    // #4
    document.getElementById("btnSpecificDate").addEventListener("click", async () => {
    const dateValue = document.getElementById("specificDateInput").value;
    const output = document.getElementById("outSpecificDate");

    // Clear previous results
    output.innerHTML = "";

    if (!dateValue) {
        output.innerHTML = "<span style='color:red;'>Please select a date.</span>";
        return;
    }

    try {
        const response = await fetch(`/items/users-by-date?created_at=${dateValue}`);
        if (!response.ok) throw new Error("Network error");

        const data = await response.json();

        if (data.length === 0) {
            output.innerHTML = "<em>No users posted on this date.</em>";
        } else {
            let html = "<ul>";
            data.forEach(user => {
                html += `<li><strong>${user.username}</strong> â€” ${user.item_count} items</li>`;
            });
            html += "</ul>";
            output.innerHTML = html;
        }
    } catch (error) {
        console.error(error);
        output.innerHTML = "<span style='color:red;'>Error fetching data.</span>";
    }
});

    document.getElementById('home-btn').addEventListener('click', async () => {
      window.location.href = '/home.html';
    });

    document.getElementById('logout').addEventListener('click', async () => {
    const res = await fetch('/logout', { method: 'POST' });

    if (res.ok) {
      alert("Logged out successfully.");
      window.location.href = '/login.html'; // Redirect to login page
    } else {
      alert("Logout failed.");
    }
  });
</script>
</body>
</html>
